<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
<meta name="GENERATOR" content="TtH 3.80">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
 <style type="text/css"> div.p { margin-top: 7pt;}</style>
 <style type="text/css"><!--
 td div.comp { margin-top: -0.6ex; margin-bottom: -1ex;}
 td div.comb { margin-top: -0.6ex; margin-bottom: -.6ex;}
 td div.hrcomp { line-height: 0.9; margin-top: -0.8ex; margin-bottom: -1ex;}
 td div.norm {line-height:normal;}
 span.roman {font-family: serif; font-style: normal; font-weight: normal;} 
 span.overacc2 {position: relative;  left: .8em; top: -1.2ex;}
 span.overacc1 {position: relative;  left: .6em; top: -1.2ex;} --></style>
	<title>Linking with native code</title>
</head>

<body>
 <h1><a name="tth_chAp1">
Chapter 1 </a><br />Linking with native code</h1><a name="extern">
</a>

<div class="p"><!----></div>
On some platforms,
X10 v2.0 supports a simple facility to permit the efficient
intra-thread communication of an array of primitive type to code
written in the language <tt>C</tt>.  The array must be a "local"
array. The primary intent of this design is to permit the reuse of
native code that efficiently implements some numeric array/matrix
calculation.

<div class="p"><!----></div>
Future language releases are expected to support similar bindings to
 Fortran, and to support parallel native processing of
distributed X10 arrays. 

<div class="p"><!----></div>
The interface consists of two parts. First, an array intended to be
communicated to native code must be created as an unsafe array
via the &#252;nsafe" annotation.
<pre>
new unsafe Array[T](dist)
</pre>
Unsafe arrays can be of any dimension. However, X10 v2.0
requires that unsafe arrays be of a primitive type, and local
(i.e.,
with an underlying distribution that maps all elements in its region
to "here").

<div class="p"><!----></div>
Unsafe arrays are allocated in a special array of memory that permits
their efficient transmission to natively linked code.

<div class="p"><!----></div>
Second, the X10 programmer may specify that certain methods are to
be implemented natively by using the modifier &#235;xtern":

<div class="p"><!----></div>
  :  |        <em>  
<table>
<tr><td align="right">MethodModifier &nbsp;&#235;xtern"
</td></tr></table>
</em>

<div class="p"><!----></div>
Such a method must be declared &#223;tatic" and may not have a
method body.<a href="#tthFtNtAAB" name="tthFrefAAB"><sup>1</sup></a>  Primitive types in
the method argument are translated to their corresponding JNI type
(e.g., <tt>Float</tt> is translated to <tt>jfloat</tt>, <tt>Double</tt> to
<tt>jdouble</tt>, etc.).  The only non-primitive type permitted in an
&#235;xtern" method is an unsafe array. This is passed at type
"jlong" as an eight-byte address into the unsafe region that contains
the data for the array.  Note that <tt>jlong</tt> is not the same as <tt>long</tt> on
32-bit machines.

<div class="p"><!----></div>
Since only the starting address of an array is passed, if the array is
multidimensional, the user must explicitly communicate (or have a
guarantee of) the rank of the passed array, and must either typecast
or explicitly code the address calculation.  Note that all X10
arrays are created in row-major order, and so any native routine must
also access them in the same order.

<div class="p"><!----></div>
For each class "C" that contains an &#235;xtern" method, the
X10 compiler generates a text file <tt>C_x10stub.c</tt>.  This file
contains generated "C" stub functions that are called from the
&#235;xtern" routines.  The name of the stub function is derived from
the name of the &#235;xtern" method. If the method is
<tt>C.process()</tt>, the stub function will be
<tt>Java_C_C_process()</tt>. The name is suffixed with the signature of the
method if the method is overloaded.

<div class="p"><!----></div>
The programmer must write C code to implement the native method,
using the methods in the "C" stub file to call the actual native
method.  The programmer must compile these files and link them into a
dynamically linked library (DLL).  Note that the <tt>jni.h</tt> header file
must be in the include path.  The programmer must ensure this library
is loaded by the program before the method is called, e.g., by
adding a
<tt>x10.lang.System.loadLibrary</tt> call (in a static initializer of the
X10 class).

<div class="p"><!----></div>
The following class illustrates the use of &#252;nsafe" and native
linking. 
<pre>
public class IntArrayExternUnsafe {
  public static extern 
      def process(yy: unsafe Rail[Int], size: Int);
  static { System.loadLibrary("IntArrayExternUnsafe"); }
  public static def main(args: Rail[String]) {
     val b = (new IntArrayExternUnsafe()).run();
     System.out.println("++++++ Test "
                         +(b?"succeeded.":"failed."));
     System.exit(b?0:1);
  }
  public def run() : Boolean {
    val high = 10;
    val d = (0..high) -&#62; here;
    val y: Array[Int] = new unsafe Array[Int](d);
    for (val (j) in y.region) {
        y(j) = j;
    process(y,high);
    for (val (j) in y.region) {
      val expected = j+100;
      if(y(j) != expected) {
        System.out.println("y("+j+")="
                           +y(j)+" != "+expected);
        return false;
       }
    }
    return true;
  }
}
}
</pre>

<div class="p"><!----></div>
The programmer may then write the <tt>C</tt> code thus:
<pre>
void IntArrayExternUnsafe_process(jlong yy, signed int size) {
  int i;
  int* array = (int*) (long) yy;
  for (i = 0; i &lt; size; i++) {
    array[i] += 100;
  }
}
/* automatically generated in C_x10stub.c */
void 
Java_IntArrayExternUnsafe_IntArrayExternUnsafe_process
(JNIEnv *env, jobject obj, jlong yy, jint size) {
   IntArrayExternUnsafe_process(yy, size);
}
</pre>

<div class="p"><!----></div>
This code may be linked with the stub file (or textually placed
in it). The programmer must then compile and link the C code and
ensure that the DLL is on the appropriate classpath. 

<div class="p"><!----></div>
<hr /><h3>Footnotes:</h3>

<div class="p"><!----></div>
<a name="tthFtNtAAB"></a><a href="#tthFrefAAB"><sup>1</sup></a>This
restriction is likely to be lifted in the future.

</body>
</html>