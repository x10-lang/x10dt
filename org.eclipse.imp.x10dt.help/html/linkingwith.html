<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
<meta name="GENERATOR" content="TtH 3.80">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
 <style type="text/css"> div.p { margin-top: 7pt;}</style>
 <style type="text/css"><!--
 td div.comp { margin-top: -0.6ex; margin-bottom: -1ex;}
 td div.comb { margin-top: -0.6ex; margin-bottom: -.6ex;}
 td div.hrcomp { line-height: 0.9; margin-top: -0.8ex; margin-bottom: -1ex;}
 td div.norm {line-height:normal;}
 span.roman {font-family: serif; font-style: normal; font-weight: normal;} 
 span.overacc2 {position: relative;  left: .8em; top: -1.2ex;}
 span.overacc1 {position: relative;  left: .6em; top: -1.2ex;} --></style>
	<title>Linking with Native Code</title>
</head>

<body>
 <h2><a name="tth_sEc1">
1</a>&nbsp;&nbsp;Linking with native code</h2><a name="extern">
</a>
 X10 v1.1 supports a simple facility to permit the efficient
intra-thread communication of an array of primitive type to code
written in the language <tt>C</tt>.  The array must be a "local"
array. The primary intent of this design is to permit the reuse of
native code that efficiently implements some numeric array/matrix
calculation.

<div class="p"><!----></div>
Future language releases are expected to support similar bindings to
 Fortran, and to support parallel native processing of
distributed  X10 arrays. 

<div class="p"><!----></div>
The interface consists of two parts. First, an array intended to be
communicated to native code must be created as an <tt>unsafe</tt> array:
<pre>
450 ArrayCreationExpression ::= 
      new ArrayBaseType Unsafeopt [ ] 
        ArrayInitializer
451    -  new ArrayBaseType Unsafeopt [ Expression ]
452    -  new ArrayBaseType Unsafeopt 
          [ Expression ] Expression
453    -  new ArrayBaseType Unsafeopt [ Expression ] 
          ( FormalParameter ) MethodBody
454    -  new ArrayBaseType value 
           Unsafeopt [ Expression ]
455    -  new ArrayBaseType value 
           Unsafeopt [ Expression ] Expression
456    -  new ArrayBaseType value 
        Unsafeopt [ Expression ] 
          ( FormalParameter ) MethodBody
530   Unsafeopt ::=
531      -  unsafe
</pre>

<div class="p"><!----></div>
Unsafe arrays can be of any dimension. However,  X10 v1.1
requires that unsafe arrays be of a primitive type, and local (i.e.
with an underlying distribution that maps all elements in its region
to <tt>here</tt>).

<div class="p"><!----></div>
Unsafe arrays are allocated in a special array of memory that permits
their efficient transmission to natively linked code.

<div class="p"><!----></div>
Second, the  X10 programmer may specify that certain methods are to
be implemented natively by using the keyword <tt>extern</tt>:
<pre>
446   MethodModifier ::= extern
</pre>

<div class="p"><!----></div>
Such a method must have the statement "<tt>;</tt>" as its body.
 X10 v1.1 requires that the method be <tt>static</tt>; this
restriction is likely to be lifted in the future.  Primitive types in
the method argument are translated to their corresponding JNI type
(e.g. <tt>float</tt> is translated to <tt>jfloat</tt>, <tt>double</tt> to
<tt>jdouble</tt> etc).  The only non-primitive type permitted in an <tt>
extern</tt> method is an (unsafe) array. This is passed at type <tt>
jlong</tt> as an eight byte address into the unsafe region which contains
the data for the array. (<tt>jlong</tt> is not the same as <tt>long</tt> on
32-bit machines.)

<div class="p"><!----></div>
Since only the starting address of an array is passed, if the array is
multidimensional, the user must explicitly communicate (or have a
guarantee of) the rank of the passed array, and must either typecast
or explicitly code the address calculation.  Note that all  X10
arrays are created in row-major order, and so any native routine must
also access them in the same order.

<div class="p"><!----></div>
For each class <tt>C</tt> that contains an <tt>extern</tt> method, the
 X10 compiler generates a text file <tt>C_x10stub.c</tt>.  This file
contains generated <tt>C</tt> stub functions which are called from the
<tt>extern</tt> routines.  The name of the stub function is derived from
the name of the <tt>extern</tt> method. If the method is <tt>
C.process()</tt>, the stub function will be <tt>
Java_C_C_process()</tt>. The name is suffixed with the signature of the
method if the method is overloaded.

<div class="p"><!----></div>
The programmer must write <tt>C</tt> code to implement the native method,
using the methods in the <tt>C</tt> stub file to call the actual native
method.  The programmer must compile these files and link them into a
dynamically linked library (DLL).  Note that the <tt>jni.h</tt> header file
must be in the include path.  The programmer must ensure this library
is loaded by the program before the method is called e.g. add a <tt>
System.loadlibrary</tt> call (in a static initializer of the
 X10 class).

<div class="p"><!----></div>

<b>Example.&nbsp;&nbsp;</b>
The following class illustrates the use of <tt>unsafe</tt> and native
linking. 
<pre>
public class IntArrayExternUnsafe {
  public static extern 
      void process(int [.] yy, int size);
  static System.loadLibrary(&#207;ntArrayExternUnsafe");
  public static void main(String args[]) {
     boolean b= (new IntArrayExternUnsafe()).run();
     System.out.println("++++++ Test "
                         +(b?&#223;ucceeded.":"failed."));
     System.exit(b?0:1);
  }
  public boolean run(){
    int high = 10;
    boolean verified=false;
    distribution d= (0:high) -&#62; here;
    int [.] y = new int unsafe[d]; 
    for( int j=0;j &lt; 10;++j)
        y[j] = j;
    process(y,high);
    for(int j=0;j &lt; 10;++j){
      int expected = j+100;
      if(y[j] != expected){
        System.out.println(&#255;["+j+"]="
                           +y[j]+" != "+expected);
        return false;
       }
    }
    return true;
  }
}
</pre>

<div class="p"><!----></div>
The programmer may then write the <tt>C</tt> code thus:
<pre>
void IntArrayExternUnsafe_process(jlong yy, 
                                signed int size){
  int i;
  int* array = (int *)(long)yy;
  for(i = 0;i &lt; size;++i){
    array[i] += 100;
  }
}
/* automatically generated in _x10stub.c*/
void 
 Java_IntArrayExternUnsafe_IntArrayExternUnsafe_process
 (JNIEnv *env,  jobject obj,jlong yy,jint size){
   IntArrayExternUnsafe_process(yy,size);
}
</pre>

<div class="p"><!----></div>
This code may be linked with the stub file (or textually placed in
it). The programmer must then compile and link the <tt>C</tt> code and
ensure that the DLL is on the appropriate classpath. 

<div class="p"><!----></div>

<br /><br /><hr /><small>File translated from
T<sub><font size="-1">E</font></sub>X
by <a href="http://hutchinson.belmont.ma.us/tth/">
T<sub><font size="-1">T</font></sub>H</a>,
version 3.80.<br />On 07 Jun 2008, 13:43.</small>
</body>
</html>