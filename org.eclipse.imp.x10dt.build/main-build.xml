<project name="Main Build File for X10DT" default="main">

  <import file="utilities.xml" />

  <property name="build.folder" value="${build.loc}/../I${buildLabel}" />
  <property name="build.qualifier" value="${buildLabel}" />

  <property file="build.properties" />

  <path id="launcher.path.ref">
    <fileset dir="../eclipse/plugins" includes="org.eclipse.equinox.launcher_*.jar" />
  </path>
  <path id="polyglot-lpg.path.ref">
    <fileset dir="${build.folder}/dependencies/repos/mirror/plugins" includes="polyglot3_*.jar" />
    <fileset dir="${build.folder}/dependencies/repos/mirror/plugins" includes="lpg.runtime_*.jar" />
    <fileset dir="${build.folder}/dependencies/repos/mirror/plugins" includes="lpg.runtime.java_*.jar" />
  </path>

  <target name="run-with-pde-build">
    <echo message="*** ${action.message}" />
    <startBuildActivity repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}" 
                        activityIdProperty="${activityId}" label="${action.message}" buildResultUUID="${buildResultUUID}" 
                        autoComplete="true" />
    <java jar="${toString:launcher.path.ref}" fork="true" failonerror="true">
      <arg value="-application" />
      <arg value="org.eclipse.ant.core.antRunner" />
      <arg value="-buildfile" />
      <arg value="${xml.file}" />
      <arg value="-DbuildLabel=${buildLabel}" />
      <arg value="-Dbuild.folder=${build.folder}" />
      <arg value="-Dpublish.update.site=${publish.update.site}" />
      <arg value="-Dbuilder=${build.loc}" />
      <jvmarg value="-XX:MaxPermSize=256M" />
      <jvmarg value="-Xmx512M" />
    </java>
  </target>

  <target name="clean-eclipse" if="clean.eclipse">
    <delete dir="../eclipse" />
    <delete dir="../delta-pack" />
  </target>

  <target name="clean-x10dist" if="clean.x10dist">
    <delete dir="../x10-build" />
  </target>

  <target name="check-log-file-existence">
    <available file="${log.file}" type="file" property="log-file-exists" />
  </target>

  <target name="publish-compilation-log" depends="check-log-file-existence" if="log-file-exists">
    <jdtCompileLogPublisher repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}" 
                            buildResultUUID="${buildResultUUID}" filePath="${log.file}" componentName="${component.name}" />
  </target>

  <target name="publish-compilation-results">
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt.core/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt.core" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt.help/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt.help" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt.refactoring/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt.refactoring" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt.ui/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt.ui" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt.ui.launch.core/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt.ui.launch.core" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/org.eclipse.imp.x10dt.ui.launch.cpp/@dot.log" />
      <param name="component.name" value="org.eclipse.imp.x10dt.ui.launch.cpp" />
    </antcall>
    <antcall target="publish-compilation-log">
      <param name="log.file" value="${build.folder}/x10.effects/@dot.log" />
      <param name="component.name" value="x10.effects" />
    </antcall>
  </target>

  <target name="post-build-cleaning">
    <delete includeEmptyDirs="true">
      <fileset dir="${buildDirectory}">
        <exclude name="buildRepo/**"/>
        <exclude name="${buildLabel}/**"/>
      </fileset>
    </delete>
    <delete includeEmptyDirs="true">
      <fileset dir="${build.folder}/dependencies"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.core" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.feature" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.help" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.refactoring" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.ui" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.ui.launch.core" defaultexcludes="false"/>
      <fileset dir="${build.folder}/org.eclipse.imp.x10dt.ui.launch.cpp" defaultexcludes="false"/>
      <fileset dir="${build.folder}/x10.effects" defaultexcludes="false"/>
    </delete>
  </target>

  <target name="main">
    <antcall target="clean-eclipse" />
    <antcall target="clean-x10dist" />

    <mkdir dir="${build.folder}" />

    <echo message="*** Download eclipse and delta pack..." />
    <ant antfile="get-eclipse.xml" />

    <antcall target="run-with-pde-build">
      <param name="action.message" value="Get LPG and Polyglot..." />
      <param name="activityId" value="download-lpg-polyglot" />
      <param name="xml.file" value="dependencies-repo.xml" />
    </antcall>

    <startBuildActivity repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}" 
                        activityIdProperty="build-x10-dist" label="Build X10 distribution and X10DT fragments..." 
                        buildResultUUID="${buildResultUUID}" autoComplete="true" />
    <echo message="*** Build X10 dist and X10DT fragments..." />
    <ant antfile="x10-build.xml">
      <property name="eclipse.target.platform" value="../../eclipse" />
      <property name="x10.compiler.extra.build.path" value="${toString:polyglot-lpg.path.ref}" />
    </ant>

    <antcall target="run-with-pde-build">
      <param name="action.message" value="Build X10DT..." />
      <param name="activityId" value="build-x10dt" />
      <param name="xml.file" value="x10dt-build.xml" />
    </antcall>

    <antcall target="publish-compilation-results"/>
    <antcall target="post-build-cleaning"/>

    <linkPublisher repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}" 
                   buildResultUUID="${buildResultUUID}" 
                   url="http://orquesta.watson.ibm.com/x10dt/2.0/x10dt-update-site-${zip.release.tag}-${buildLabel}.zip"
                   label="Build ${buildLabel} is available on orquesta's update site." />
  </target>

</project>