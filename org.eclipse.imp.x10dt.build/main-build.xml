<project name="Main Build File for X10DT" default="main">

	<import file="utilities.xml" />
	
	<property name="build.folder" value="${build.loc}/../I${buildLabel}" />
	<property name="build.qualifier" value="${buildLabel}" />
	
	<property file="build.properties" />

	<path id="launcher.path.ref">
		<fileset dir="../eclipse/plugins" includes="org.eclipse.equinox.launcher_*.jar" />
	</path>
	<path id="polyglot-lpg.path.ref">
		<fileset dir="${build.folder}/dependencies/repos/mirror/plugins" includes="polyglot3_*.jar"/>
		<fileset dir="${build.folder}/dependencies/repos/mirror/plugins" includes="lpg.runtime_*.jar"/>
		<fileset dir="${build.folder}/dependencies/repos/mirror/plugins" includes="lpg.runtime.java_*.jar"/>
	</path>

	<target name="run-with-pde-build">
		<echo message="*** ${action.message}" />
		<startBuildActivity repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}"
							activityIdProperty="${activityId}" label="${action.message}" 
							buildResultUUID="${buildResultUUID}" autoComplete="true" />
		<java jar="${toString:launcher.path.ref}" fork="true" failonerror="true">
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-buildfile" />
			<arg value="${xml.file}" />
			<arg value="-DbuildLabel=${buildLabel}" />
			<arg value="-Dbuild.folder=${build.folder}" />
			<arg value="-Dpublish.update.site=${publish.update.site}" />
			<arg value="-Dbuilder=${build.loc}" />
			<jvmarg value="-XX:MaxPermSize=256M"/>
			<jvmarg value="-Xmx512M"/>
		</java>
	</target>

	<target name="main">
		<mkdir dir="${build.folder}" />

		<echo message="*** Download eclipse and delta pack..." />
		<ant antfile="get-eclipse.xml" />

		<antcall target="run-with-pde-build">
			<param name="action.message" value="Get LPG and Polyglot..."/>
			<param name="activityId" value="download-lpg-polyglot"/>
			<param name="xml.file" value="dependencies-repo.xml" />
		</antcall>

		<startBuildActivity repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}"
							activityIdProperty="build-x10-dist" label="Build X10 distribution and X10DT fragments..."
							buildResultUUID="${buildResultUUID}" autoComplete="true" />
		<echo message="*** Build X10 dist and X10DT fragments..." />
		<ant antfile="x10-build.xml">
			<property name="eclipse.target.platform" value="../../eclipse" />
			<property name="x10.compiler.extra.build.path" value="${toString:polyglot-lpg.path.ref}"/>
		</ant>

		<antcall target="run-with-pde-build">
			<param name="action.message" value="Build X10DT..." />
			<param name="activityId" value="build-x10dt" />
			<param name="xml.file" value="x10dt-build.xml" />
		</antcall>
		<jdtCompileLogPublisher repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}"
				                buildResultUUID="${buildResultUUID}" 
							    filePath="${buildDirectory}/${buildLabel}/compilelogs/plugins" />
		<linkPublisher repositoryAddress="${repositoryAddress}" userId="${userId}" passwordFile="${passwordFile}"
				       buildResultUUID="${buildResultUUID}" url="http://orquesta.watson.ibm.com/x10dt/2.0"
				       label="Build ${buildLabel} is available on orquesta's update site." />
	</target>

</project>